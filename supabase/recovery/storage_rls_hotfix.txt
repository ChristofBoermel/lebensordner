BEGIN;

GRANT SELECT, INSERT, UPDATE, DELETE ON storage.objects TO authenticated;
GRANT ALL PRIVILEGES ON storage.objects TO service_role;

ALTER TABLE storage.objects ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Upload docs by uid prefix" ON storage.objects;
DROP POLICY IF EXISTS "Read docs by uid prefix" ON storage.objects;
DROP POLICY IF EXISTS "Update docs by uid prefix" ON storage.objects;
DROP POLICY IF EXISTS "Delete docs by uid prefix" ON storage.objects;
DROP POLICY IF EXISTS "Service role storage all" ON storage.objects;

CREATE POLICY "Upload docs by uid prefix"
ON storage.objects
FOR INSERT
TO authenticated
WITH CHECK (
  bucket_id = 'documents'
  AND name LIKE auth.uid()::text || '/%'
);

CREATE POLICY "Read docs by uid prefix"
ON storage.objects
FOR SELECT
TO authenticated
USING (
  bucket_id = 'documents'
  AND name LIKE auth.uid()::text || '/%'
);

CREATE POLICY "Update docs by uid prefix"
ON storage.objects
FOR UPDATE
TO authenticated
USING (
  bucket_id = 'documents'
  AND name LIKE auth.uid()::text || '/%'
)
WITH CHECK (
  bucket_id = 'documents'
  AND name LIKE auth.uid()::text || '/%'
);

CREATE POLICY "Delete docs by uid prefix"
ON storage.objects
FOR DELETE
TO authenticated
USING (
  bucket_id = 'documents'
  AND name LIKE auth.uid()::text || '/%'
);

CREATE POLICY "Service role storage all"
ON storage.objects
FOR ALL
TO service_role
USING (true)
WITH CHECK (true);

COMMIT;
